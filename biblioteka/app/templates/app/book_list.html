{% extends 'app/base.html' %}
{% block title %}
    Manage books
{% endblock %}

{% block content %}
    
<h1>Books</h1>

<!-- Formularz wyszukiwania -->
<form method="get" action="{% url 'book_list' %}">
    <div class="input-group mb-3">
        <input type="text" class="form-control" placeholder="Search books..." name="search_query">
        <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="submit">Search</button>
        </div>
    </div>
</form>

<div class="input-group-prepend">
    <ul>
        {% for book in books %}
            <li style="margin:3px">
                <strong>{{ book.title }}</strong> - {{ book.author }} - {{ book.genre }} ({{ book.year }}) - PUBLISHED BY {{ book.publisher }} -

                {% if book.available %}
                    <span style="color:green;">Available</span> 
                {% else %}
                    <span style="color:red;">Unavailable</span> 
                {% endif %}

                <!-- Dodaj sekcję do wyświetlania opinii -->
                <button class="btn btn-link" data-toggle="collapse" data-target="#opinions{{ book.id }}">Show Opinions</button>
                <div id="opinions{{ book.id }}" class="collapse">
                    <ul>
                        {% for opinion in book.localopinions_set.all %}
                            <li>
                                {{ opinion.user.username }}: {{ opinion.opinion }}
                                {% if opinion.user == user %}
                                    <form method="post" action="{% url 'delete_opinion' opinion.id %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger btn-sm">Delete Opinion</button>
                                    </form>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                    {% if not book.user_has_opinion %}
                    <form method="post" action="{% url 'add_opinion' book.id %}">
                        {% csrf_token %}
                        <textarea name="opinion" placeholder="Your opinion" required></textarea>
                        <input type="number" name="rating" placeholder="Rating (1-10)" min="1" max="10" required>
                        <button type="submit" class="btn btn-primary">Add Opinion</button>
                    </form>
                    {% else %}
                    <p>You have already submitted an opinion for this book.</p>
                    {% endif %}
                </div>

                <!-- Nowy przycisk "Show more opinions" -->
                <button class="btn btn-link show-more-opinions" data-book-id="{{ book.id }}">Show more opinions</button>
                <div id="external-opinions{{ book.id }}" class="collapse">
                    <!-- Miejsce na zewnętrzne opinie -->
                    <ul class="external-opinions-list"></ul>
                </div>

            </li>
        {% endfor %}
    </ul>
</div>

{% if user.is_authenticated %}
    <a href="{% url 'add_book' %}" class="btn btn-success">Add a new book</a>
{% endif %}

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var showMoreButtons = document.querySelectorAll(".show-more-opinions");
        showMoreButtons.forEach(function(button) {
            button.addEventListener("click", function() {
                var bookId = this.getAttribute("data-book-id");
                var externalOpinionsList = document.querySelector("#external-opinions" + bookId + " .external-opinions-list");

                // Sprawdź, czy opinie już zostały załadowane
                if (externalOpinionsList.childElementCount === 0) {
                    fetch(`/fetch-reviews/${bookId}/`)
                        .then(response => response.json())
                        .then(data => {
                            data.reviews.forEach(opinion => {
                                var li = document.createElement("li");
                                li.textContent = opinion;
                                externalOpinionsList.appendChild(li);
                            });
                        });
                }

                // Pokaż lub ukryj opinie
                var externalOpinionsDiv = document.getElementById("external-opinions" + bookId);
                if (externalOpinionsDiv.classList.contains('show')) {
                    externalOpinionsDiv.classList.remove('show');
                } else {
                    externalOpinionsDiv.classList.add('show');
                }
            });
        });
    });
</script>
{% endblock %}
